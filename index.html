<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek Chat | OpenRouter API</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.1/marked.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #f3f4f6;
            --dark: #1f2937;
            --light: #ffffff;
            --gray: #9ca3af;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            background: var(--light);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 95vh;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .logo {
            font-size: 1.5rem;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .api-status {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray);
            margin-right: 6px;
        }
        
        .status-dot.connected {
            background: var(--success);
        }
        
        .status-dot.error {
            background: var(--error);
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .message {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: 18px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .message-content {
            overflow-wrap: break-word;
        }
        
        .message-content pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .message-content code {
            font-family: 'Fira Code', monospace;
            font-size: 0.9em;
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .message-content pre code {
            background: none;
            padding: 0;
        }
        
        .message-content h1, 
        .message-content h2, 
        .message-content h3 {
            margin-top: 15px;
            margin-bottom: 10px;
        }
        
        .message-content p {
            margin-bottom: 10px;
        }
        
        .message-content ul, 
        .message-content ol {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        
        .message-content blockquote {
            border-left: 4px solid #ddd;
            padding-left: 15px;
            margin: 15px 0;
            color: #666;
        }
        
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }
        
        .message-content th, 
        .message-content td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        
        .message-content th {
            background-color: #f5f5f5;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .ai-message {
            align-self: flex-start;
            background: var(--secondary);
            color: var(--dark);
            border-bottom-left-radius: 4px;
        }
        
        .message-info {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            display: block;
        }
        
        .input-container {
            padding: 16px;
            background: var(--light);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
        }
        
        #user-input {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid var(--gray);
            border-radius: 24px;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        #user-input:focus {
            border-color: var(--primary);
        }
        
        #send-button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 24px;
            padding: 0 24px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        #send-button:hover {
            background: var(--primary-dark);
        }
        
        #send-button:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }
        
        .typing-indicator {
            display: none;
            align-self: flex-start;
            background: var(--secondary);
            color: var(--dark);
            padding: 12px 16px;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            margin-bottom: 10px;
        }
        
        .typing-indicator.active {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .dot {
            width: 6px;
            height: 6px;
            background: var(--dark);
            border-radius: 50%;
            opacity: 0.6;
            animation: pulse 1.5s infinite;
        }
        
        .dot:nth-child(2) {
            animation-delay: 0.5s;
        }
        
        .dot:nth-child(3) {
            animation-delay: 1s;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }
        
        .info-panel {
            background: var(--secondary);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        
        .info-panel h3 {
            margin-bottom: 10px;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-text {
            line-height: 1.5;
        }
        
        .config-panel {
            background: #fffbeb;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            font-size: 0.9rem;
            border-left: 4px solid var(--warning);
        }
        
        .config-panel h3 {
            margin-bottom: 10px;
            color: var(--warning);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .api-config-form {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 12px;
            margin-top: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group label {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        #api-key-input, #model-input {
            padding: 10px 15px;
            border: 1px solid var(--gray);
            border-radius: 8px;
            outline: none;
            font-size: 0.9rem;
        }
        
        #save-config {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            grid-column: span 2;
            margin-top: 5px;
        }
        
        #save-config:hover {
            background: var(--primary-dark);
        }
        
        .cf-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.05);
        }
        
        .cf-status i {
            font-size: 1.2rem;
        }
        
        .cf-status.success {
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .cf-status.error {
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        
        #clear-chat {
            background: var(--gray);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        #clear-chat:hover {
            background: var(--error);
        }
        
        code {
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        a {
            color: var(--primary);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .container {
                height: 95vh;
            }
            
            .message {
                max-width: 90%;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .api-status {
                position: relative;
                top: 0;
                right: 0;
                justify-content: center;
                margin-top: 10px;
            }
            
            header {
                padding: 15px;
            }
            
            .api-config-form {
                grid-template-columns: 1fr;
            }
            
            #save-config {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-robot logo"></i> DeepSeek Chat</h1>
            <div class="subtitle">Powered by OpenRouter API</div>
            <div class="api-status">
                <span class="status-dot" id="status-dot"></span>
                <span id="status-text">Checking API</span>
            </div>
        </header>
        
        <div class="chat-container" id="chat-container">
            <div class="message ai-message">
                <div class="message-content">
                    <i class="fas fa-robot"></i> Hello! I'm DeepSeek, an AI assistant powered by OpenRouter. How can I help you today?
                </div>
                <span class="message-info">Model: <span id="current-model">deepseek/deepseek-chat-v3.1:free</span></span>
            </div>
            
            <div class="config-panel">
                <h3><i class="fas fa-cog"></i> Configuration</h3>
                <p class="info-text" id="config-status">Checking configuration...</p>
                <div id="cloudflare-status" class="cf-status">
                    <i class="fas fa-cloud"></i>
                    <span>Checking Cloudflare environment variable...</span>
                </div>
                <div class="api-config-form">
                    <div class="form-group">
                        <label for="api-key-input">OpenRouter API Key</label>
                        <input type="password" id="api-key-input" placeholder="Enter your API key">
                    </div>
                    <div class="form-group">
                        <label for="model-input">Model Name</label>
                        <input type="text" id="model-input" value="deepseek/deepseek-chat-v3.1:free" placeholder="Enter model name">
                    </div>
                    <button id="save-config">Save Configuration</button>
                </div>
            </div>
            
            <div class="info-panel">
                <h3><i class="fas fa-info-circle"></i> Information</h3>
                <div class="info-text">
                    <p>This chat interface uses the OpenRouter API to connect to AI models. It will first try to use the API key from Cloudflare Pages environment variables, but you can also manually provide one.</p>
                    <p>Get your API key from <a href="https://openrouter.ai/keys" target="_blank">https://openrouter.ai/keys</a></p>
                    <p>Some popular models you can try:</p>
                    <ul>
                        <li><code>deepseek/deepseek-chat-v3.1:free</code> - Free DeepSeek model</li>
                        <li><code>openai/gpt-3.5-turbo</code> - OpenAI's GPT-3.5 Turbo</li>
                        <li><code>anthropic/claude-3-haiku</code> - Anthropic's Claude 3 Haiku</li>
                        <li><code>google/gemini-pro</code> - Google's Gemini Pro</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="typing-indicator" id="typing-indicator">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <span id="typing-model">DeepSeek is typing...</span>
        </div>
        
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Type your message here..." autocomplete="off" disabled>
            <button id="send-button" disabled>
                <i class="fas fa-paper-plane"></i> Send
            </button>
        </div>
        
        <div class="controls">
            <button id="clear-chat">
                <i class="fas fa-trash"></i> Clear Chat
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatContainer = document.getElementById('chat-container');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const typingIndicator = document.getElementById('typing-indicator');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const configStatus = document.getElementById('config-status');
            const apiKeyInput = document.getElementById('api-key-input');
            const modelInput = document.getElementById('model-input');
            const saveConfigButton = document.getElementById('save-config');
            const currentModelElement = document.getElementById('current-model');
            const typingModelElement = document.getElementById('typing-model');
            const cloudflareStatus = document.getElementById('cloudflare-status');
            const clearChatButton = document.getElementById('clear-chat');
            
            // API configuration
            const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
            let API_KEY = '';
            let MODEL_NAME = 'deepseek/deepseek-chat-v3.1:free';
            
            // Conversation history
            let conversationHistory = [
                {
                    role: 'system',
                    content: 'You are a helpful AI assistant. Format your responses using Markdown for better readability. Use code blocks for code snippets.'
                }
            ];
            
            // Configure marked to render code blocks with syntax highlighting
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                }
            });
            
            // Check for Cloudflare Pages environment variable
            function checkCloudflareEnv() {
                // This will be replaced at build time by Cloudflare Pages
                // The variable needs to be injected into the HTML during build
                const cfApiKey = '{{API_KEY}}';
                
                if (cfApiKey && cfApiKey !== '{{API_KEY}}' && cfApiKey.length > 10) {
                    // Valid Cloudflare environment variable found
                    API_KEY = cfApiKey;
                    cloudflareStatus.innerHTML = `<i class="fas fa-check-circle"></i> <span>Using API key from Cloudflare environment variable: <code>${cfApiKey.substring(0, 10)}...</code></span>`;
                    cloudflareStatus.classList.add('success');
                    return true;
                } else {
                    // No valid Cloudflare environment variable found
                    cloudflareStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> <span>No API key found in Cloudflare environment variables. Please provide one manually.</span>';
                    cloudflareStatus.classList.add('error');
                    return false;
                }
            }
            
            // Check for saved configuration
            function initializeConfig() {
                const cloudflareResult = checkCloudflareEnv();
                
                // Check localStorage for model name
                const savedModel = localStorage.getItem('openrouter_model');
                if (savedModel) {
                    MODEL_NAME = savedModel;
                    modelInput.value = savedModel;
                    currentModelElement.textContent = savedModel;
                    typingModelElement.textContent = `${savedModel.split('/').pop()} is typing...`;
                }
                
                // Load conversation history from localStorage if available
                const savedHistory = localStorage.getItem('conversation_history');
                if (savedHistory) {
                    try {
                        conversationHistory = JSON.parse(savedHistory);
                        // Re-render the conversation from history
                        renderConversationHistory();
                    } catch (e) {
                        console.error('Error loading conversation history:', e);
                        conversationHistory = [
                            {
                                role: 'system',
                                content: 'You are a helpful AI assistant. Format your responses using Markdown for better readability. Use code blocks for code snippets.'
                            }
                        ];
                    }
                }
                
                if (cloudflareResult) {
                    configStatus.innerHTML = `Configuration loaded from Cloudflare. Using model: <code>${MODEL_NAME}</code>`;
                    return true;
                }
                
                // Check localStorage for API key if Cloudflare didn't provide one
                const savedApiKey = localStorage.getItem('openrouter_api_key');
                if (savedApiKey) {
                    API_KEY = savedApiKey;
                    apiKeyInput.value = savedApiKey;
                    configStatus.innerHTML = `Configuration loaded from browser storage. Using model: <code>${MODEL_NAME}</code>`;
                    return true;
                }
                
                configStatus.innerHTML = 'Please configure your API settings above';
                return false;
            }
            
            // Render conversation history
            function renderConversationHistory() {
                // Clear the chat container except for the first message and config panels
                const children = chatContainer.children;
                const elementsToKeep = [children[0], children[1], children[2]]; // Keep initial messages and config
                
                while (chatContainer.children.length > 3) {
                    chatContainer.removeChild(chatContainer.lastChild);
                }
                
                // Add messages from history (skip system message)
                for (const message of conversationHistory) {
                    if (message.role === 'user') {
                        addMessage(message.content, 'user', false);
                    } else if (message.role === 'assistant') {
                        addMessage(message.content, 'ai', false);
                    }
                }
            }
            
            // Check if API key is available
            function checkApiKey() {
                if (!API_KEY) {
                    updateStatus('API key required', false);
                    addMessage('System: Please enter your OpenRouter API key to start chatting.', 'ai');
                    userInput.disabled = true;
                    sendButton.disabled = true;
                    return false;
                }
                
                updateStatus('API key loaded', true);
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
                return true;
            }
            
            // Update connection status UI
            function updateStatus(text, connected) {
                statusText.textContent = text;
                if (connected) {
                    statusDot.classList.add('connected');
                    statusDot.classList.remove('error');
                } else {
                    statusDot.classList.add('error');
                    statusDot.classList.remove('connected');
                }
            }
            
            // Add message to chat with markdown support
            function addMessage(text, sender, addToHistory = true) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                messageElement.classList.add(sender + '-message');
                
                const messageContent = document.createElement('div');
                messageContent.classList.add('message-content');
                
                // Add sender icon
                const icon = document.createElement('i');
                icon.className = sender === 'ai' ? 'fas fa-robot' : 'fas fa-user';
                
                // Parse markdown if it's an AI message
                if (sender === 'ai') {
                    messageContent.innerHTML = marked.parse(text);
                } else {
                    messageContent.textContent = text;
                }
                
                messageElement.appendChild(icon);
                messageElement.appendChild(messageContent);
                
                // Insert before the config panel
                const configPanel = document.querySelector('.config-panel');
                chatContainer.insertBefore(messageElement, configPanel);
                
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Highlight any code blocks in the message
                messageContent.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                // Add to conversation history
                if (addToHistory) {
                    if (sender === 'user') {
                        conversationHistory.push({ role: 'user', content: text });
                    } else if (sender === 'ai') {
                        conversationHistory.push({ role: 'assistant', content: text });
                    }
                    
                    // Save conversation history to localStorage
                    localStorage.setItem('conversation_history', JSON.stringify(conversationHistory));
                }
            }
            
            // Show/hide typing indicator
            function setTyping(visible) {
                typingIndicator.classList.toggle('active', visible);
                if (visible) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
            
            // Send message to API
            async function sendMessage() {
                const message = userInput.value.trim();
                if (!message) return;
                
                // Add user message to chat
                addMessage(message, 'user');
                userInput.value = '';
                sendButton.disabled = true;
                setTyping(true);
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_KEY}`,
                            'HTTP-Referer': window.location.href,
                            'X-Title': 'DeepSeek Chat Interface'
                        },
                        body: JSON.stringify({
                            model: MODEL_NAME,
                            messages: conversationHistory
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content;
                    
                    setTyping(false);
                    addMessage(aiResponse, 'ai');
                    updateStatus('Response received', true);
                } catch (error) {
                    setTyping(false);
                    addMessage(`Error: ${error.message}. Please check your API key and try again.`, 'ai');
                    updateStatus('API error', false);
                    console.error('Error:', error);
                }
                
                sendButton.disabled = false;
                userInput.focus();
            }
            
            // Save configuration
            function saveConfig() {
                const key = apiKeyInput.value.trim();
                const model = modelInput.value.trim();
                
                if (!key) {
                    alert('Please enter a valid API key');
                    return;
                }
                
                if (!model) {
                    alert('Please enter a model name');
                    return;
                }
                
                API_KEY = key;
                MODEL_NAME = model;
                
                localStorage.setItem('openrouter_api_key', key);
                localStorage.setItem('openrouter_model', model);
                
                currentModelElement.textContent = model;
                typingModelElement.textContent = `${model.split('/').pop()} is typing...`;
                configStatus.innerHTML = `Configuration saved. Using model: <code>${model}</code>`;
                checkApiKey();
            }
            
            // Clear chat history
            function clearChat() {
                if (confirm('Are you sure you want to clear the conversation history?')) {
                    conversationHistory = [
                        {
                            role: 'system',
                            content: 'You are a helpful AI assistant. Format your responses using Markdown for better readability. Use code blocks for code snippets.'
                        }
                    ];
                    
                    localStorage.removeItem('conversation_history');
                    
                    // Clear the chat container except for the first message and config panels
                    const children = chatContainer.children;
                    const elementsToKeep = [children[0], children[1], children[2]]; // Keep initial messages and config
                    
                    while (chatContainer.children.length > 3) {
                        chatContainer.removeChild(chatContainer.lastChild);
                    }
                    
                    addMessage('Conversation history has been cleared.', 'ai');
                }
            }
            
            // Event listeners
            sendButton.addEventListener('click', sendMessage);
            saveConfigButton.addEventListener('click', saveConfig);
            clearChatButton.addEventListener('click', clearChat);
            
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            apiKeyInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveConfig();
                }
            });
            
            modelInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveConfig();
                }
            });
            
            // Initialize the app
            initializeConfig();
            checkApiKey();
        });
    </script>
</body>
</html>
