<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adam's AI UI v2.1 | Document Processing</title>
    <link rel="icon" type="image/x-icon" href="https://img.icons8.com/?size=100&id=XNotH4e8lEuO&format=png&color=000000">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #f3f4f6;
            --dark: #1f2937;
            --light: #ffffff;
            --gray: #9ca3af;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --sidebar-width: 320px;
            --sidebar-collapsed-width: 50px;
            --transition-speed: 0.3s;
            --header-height: 80px;
            --input-height: 80px;
            --controls-height: 70px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            padding: 0;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--light);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: width var(--transition-speed) ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 10;
            height: 100vh;
        }
        
        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }
        
        .sidebar-header {
            padding: 20px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: var(--header-height);
            flex-shrink: 0;
        }
        
        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .toggle-sidebar {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .toggle-sidebar:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            height: calc(100vh - var(--header-height));
        }
        
        .sidebar-section {
            margin-bottom: 25px;
            opacity: 1;
            transition: opacity var(--transition-speed) ease;
        }
        
        .sidebar.collapsed .sidebar-section {
            opacity: 0;
            pointer-events: none;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: var(--primary-dark);
            font-weight: 600;
            font-size: 1rem;
        }
        
        .section-header i {
            margin-right: 10px;
            font-size: 1.1rem;
        }
        
        .section-content {
            padding-left: 28px;
        }
        
        .info-text {
            line-height: 1.6;
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .info-text p {
            margin-bottom: 10px;
        }
        
        .api-config-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--dark);
        }
        
        #api-key-input, #endpoint-input, #model-input {
            padding: 10px 15px;
            border: 1px solid var(--gray);
            border-radius: 8px;
            outline: none;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }
        
        #api-key-input:focus, #endpoint-input:focus, #model-input:focus {
            border-color: var(--primary);
        }
        
        #save-config {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            margin-top: 5px;
        }
        
        #save-config:hover {
            background: var(--primary-dark);
        }
        
        .cf-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.05);
            font-size: 0.85rem;
        }
        
        .cf-status i {
            font-size: 1rem;
            width: 16px;
        }
        
        .cf-status.success {
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .cf-status.error {
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }
        
        code {
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
        }
        
        ul, ol {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        li {
            margin-bottom: 5px;
            line-height: 1.5;
        }
        
        a {
            color: var(--primary);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        /* Chat Sessions Panel */
        .chat-sessions-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100vh;
            background: var(--light);
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: right var(--transition-speed) ease;
            z-index: 20;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-sessions-panel.open {
            right: 0;
        }
        
        .sessions-header {
            padding: 20px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: var(--header-height);
        }
        
        .sessions-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .close-sessions {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .close-sessions:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .sessions-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .session-item {
            padding: 15px;
            border-radius: 8px;
            background: var(--secondary);
            margin-bottom: 15px;
            cursor: pointer;
            transition: background 0.3s;
            position: relative;
        }
        
        .session-item:hover {
            background: #e5e7eb;
        }
        
        .session-item.active {
            background: var(--primary);
            color: white;
        }
        
        .session-title {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .session-preview {
            font-size: 0.85rem;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .session-date {
            font-size: 0.75rem;
            margin-top: 8px;
            opacity: 0.7;
        }
        
        .session-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        
        .session-action {
            background: rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s;
        }
        
        .session-item.active .session-action {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .session-action:hover {
            background: rgba(0, 0, 0, 0.2);
        }
        
        .session-item.active .session-action:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .no-sessions {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-style: italic;
        }
        
        .new-session-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 15px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            width: 100%;
        }
        
        .new-session-btn:hover {
            background: var(--primary-dark);
        }
        
        /* Compact Document Upload Area */
        .document-upload {
            padding: 10px 16px;
            background: var(--light);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .upload-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        
        .upload-title {
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .upload-content {
            display: none;
            flex-direction: column;
            gap: 8px;
        }
        
        .upload-content.expanded {
            display: flex;
        }
        
        .drop-area {
            border: 2px dashed var(--gray);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
            font-size: 0.85rem;
        }
        
        .drop-area:hover, .drop-area.active {
            border-color: var(--primary);
        }
        
        .drop-area i {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .drop-text {
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        
        .file-input {
            display: none;
        }
        
        .browse-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            font-size: 0.8rem;
        }
        
        .browse-btn:hover {
            background: var(--primary-dark);
        }
        
        .file-preview {
            margin-top: 8px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background: var(--secondary);
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .file-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            border-radius: 3px;
            font-size: 0.7rem;
        }
        
        .file-details {
            flex: 1;
            overflow: hidden;
        }
        
        .file-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.85rem;
        }
        
        .file-size {
            font-size: 0.75rem;
            color: var(--gray);
        }
        
        .file-remove {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 1rem;
            padding: 4px;
        }
        
        .file-remove:hover {
            color: #dc2626;
        }
        
        .file-type-warning {
            font-size: 0.75rem;
            color: var(--error);
            margin-top: 5px;
            display: none;
        }
        
        .uploaded-files-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--primary);
        }
        
        /* File attachment in chat */
        .file-attachment {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .file-attachment-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            border-radius: 3px;
            font-size: 0.7rem;
        }
        
        .file-attachment-name {
            font-weight: 600;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--light);
            border-radius: 0;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            height: 100vh;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            height: var(--header-height);
            flex-shrink: 0;
        }
        
        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .logo {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .api-status {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray);
            margin-right: 6px;
        }
        
        .status-dot.connected {
            background: var(--success);
        }
        
        .status-dot.error {
            background: var(--error);
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            height: calc(100vh - var(--header-height) - var(--input-height) - var(--controls-height) - 60px);
        }
        
        .message {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: 18px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .message-content {
            overflow-wrap: break-word;
        }
        
        .message-content pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            position: relative;
        }
        
        .copy-button {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .run-button {
            position: absolute;
            bottom: 8px;
            right: 70px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .message-content pre:hover .copy-button,
        .message-content pre:hover .run-button {
            opacity: 1;
        }
        
        .copy-button:hover {
            background: var(--primary-dark);
        }
        
        .run-button:hover {
            background: #0da271;
        }
        
        .copy-button.copied {
            background: var(--success);
        }
        
        .message-content code {
            font-family: 'Fira Code', monospace;
            font-size: 0.9em;
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .message-content pre code {
            background: none;
            padding: 0;
        }
        
        .message-content h1, 
        .message-content h2, 
        .message-content h3 {
            margin-top: 15px;
            margin-bottom: 10px;
        }
        
        .message-content p {
            margin-bottom: 10px;
        }
        
        .message-content ul, 
        .message-content ol {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        
        .message-content blockquote {
            border-left: 4px solid #ddd;
            padding-left: 15px;
            margin: 15px 0;
            color: #666;
        }
        
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }
        
        .message-content th, 
        .message-content td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        
        .message-content th {
            background-color: #f5f5f5;
        }
        
        .thinking-header {
            font-weight: bold;
            color: #6366f1;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .thinking-message {
            background-color: #f8f9fa;
            border-left: 4px solid #6366f1;
            padding: 12px 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: #495057;
        }

        .thinking-message pre {
            font-style: normal;
            background: rgba(0, 0, 0, 0.05);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .thinking-message code {
            font-family: 'Fira Code', monospace;
            font-size: 0.9em;
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .thinking-message pre code {
            background: none;
            padding: 0;
        }

        .final-answer-header {
            font-weight: bold;
            color: #10b981;
            margin: 15px 0 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .final-answer {
            background-color: #f0fdf4;
            border-left: 4px solid #10b981;
            padding: 12px 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .ai-message {
            align-self: flex-start;
            background: var(--secondary);
            color: var(--dark);
            border-bottom-left-radius: 4px;
        }
        
        .message-info {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            display: block;
        }
        
        .input-container {
            padding: 16px;
            background: var(--light);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
            flex-shrink: 0;
            height: var(--input-height);
        }
        
        #user-input {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid var(--gray);
            border-radius: 24px;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        #user-input:focus {
            border-color: var(--primary);
        }
        
        #send-button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 24px;
            padding: 0 24px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        #send-button:hover {
            background: var(--primary-dark);
        }
        
        #send-button:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }
        
        .typing-indicator {
            display: none;
            align-self: flex-start;
            background: var(--secondary);
            color: var(--dark);
            padding: 12px 16px;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            margin-bottom: 10px;
        }
        
        .typing-indicator.active {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .dot {
            width: 6px;
            height: 6px;
            background: var(--dark);
            border-radius: 50%;
            opacity: 0.6;
            animation: pulse 1.5s infinite;
        }
        
        .dot:nth-child(2) {
            animation-delay: 0.5s;
        }
        
        .dot:nth-child(3) {
            animation-delay: 1s;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding: 0 20px 15px 20px;
            height: var(--controls-height);
            align-items: center;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
        }
        
        #clear-chat, #save-pdf, #view-sessions {
            background: var(--gray);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #clear-chat:hover {
            background: var(--error);
        }
        
        #save-pdf {
            background: var(--success);
        }
        
        #save-pdf:hover {
            background: #0da271;
        }
        
        #view-sessions {
            background: var(--primary);
        }
        
        #view-sessions:hover {
            background: var(--primary-dark);
        }
        
        .hidden {
            display: none;
        }
        
        .pdf-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            display: none;
        }
        
        .pdf-loading .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 60px;
                overflow: hidden;
                transition: max-height var(--transition-speed) ease;
            }
            
            .sidebar.expanded {
                max-height: 70vh;
                overflow-y: auto;
            }
            
            .sidebar.collapsed {
                width: 100%;
                max-height: 60px;
            }
            
            .sidebar.collapsed .sidebar-section {
                display: none;
            }
            
            .main-content {
                height: auto;
                min-height: calc(100vh - 60px);
            }
            
            .chat-container {
                height: auto;
                min-height: calc(100vh - var(--header-height) - var(--input-height) - var(--controls-height) - 60px);
            }
            
            .message {
                max-width: 90%;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .api-status {
                position: relative;
                top: 0;
                right: 0;
                justify-content: center;
                margin-top: 10px;
            }
            
            header {
                padding: 15px;
            }
            
            .controls {
                flex-direction: column;
                height: auto;
                padding: 15px 20px;
            }
            
            .control-group {
                width: 100%;
                justify-content: space-between;
            }
            
            .document-upload {
                padding: 8px 12px;
            }
            
            .drop-area {
                padding: 10px;
            }
            
            .chat-sessions-panel {
                width: 85%;
                right: -85%;
            }
        }
        
        /* Fallback styles for code highlighting if hljs fails */
        .hljs-fallback {
            color: #24292e;
            background: #f6f8fa;
        }
        
        .hljs-fallback .hljs-keyword {
            color: #d73a49;
        }
        
        .hljs-fallback .hljs-string {
            color: #032f62;
        }
        
        .hljs-fallback .hljs-function {
            color: #6f42c1;
        }
        
        .hljs-fallback .hljs-comment {
            color: #6a737d;
        }
        
        .hljs-fallback .hljs-number {
            color: #005cc5;
        }
        
        .hljs-fallback .hljs-tag {
            color: #22863a;
        }
        
        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #c33;
        }
        
        /* Version info */
        .version-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 0.7rem;
            color: var(--gray);
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Configuration Panel</div>
                <button class="toggle-sidebar" id="toggle-sidebar">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <div class="sidebar-content">
                <div class="sidebar-section">
                    <div class="section-header">
                        <i class="fas fa-cog"></i> Configuration
                    </div>
                    <div class="section-content">
                        <p class="info-text" id="config-status">Configure your API settings to get started.</p>
                        <div id="cloudflare-status" class="cf-status">
                            <i class="fas fa-cloud"></i>
                            <span>Checking Cloudflare environment variable...</span>
                        </div>
                        <div class="api-config-form">
                            <div class="form-group">
                                <label for="api-key-input">API Key</label>
                                <input type="password" id="api-key-input" placeholder="Enter your API key">
                            </div>
                            <div class="form-group">
                                <label for="endpoint-input">API Endpoint</label>
                                <input type="text" id="endpoint-input" value="https://openrouter.ai/api/v1/chat/completions" placeholder="Enter API endpoint">
                            </div>
                            <div class="form-group">
                                <label for="model-input">Model Name</label>
                                <input type="text" id="model-input" value="deepseek/deepseek-chat-v3.1:free" placeholder="Enter model name">
                            </div>
                            <button id="save-config">Save Configuration</button>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="section-header">
                        <i class="fas fa-info-circle"></i> Information
                    </div>
                    <div class="section-content">
                        <div class="info-text">
                            <p>This chat interface can connect to various AI APIs. By default, it uses the OpenRouter API, but you can change the endpoint to use other services.</p>
                            <p>Get your OpenRouter API key from <a href="https://openrouter.ai/keys" target="_blank">https://openrouter.ai/keys</a></p>
                            <p>Popular API endpoints:</p>
                            <ul>
                                <li><code>https://openrouter.ai/api/v1/chat/completions</code> - OpenRouter</li>
                                <li><code>https://api.deepinfra.com/v1/openai/chat/completions</code> - DeepInfra</li>
                            </ul>
                            <p>Some popular models you can try:</p>
                            <ul>
                                <li><code>deepseek/deepseek-chat-v3.1:free</code> - DeepSeek v3.1 - OpenRouter</li>
                                <li><code>meta-llama/llama-3.3-70b-instruct:free</code> - Meta: Llama 3.3 70B - OpenRouter</li>
                                <li><code>cognitivecomputations/dolphin-mistral-24b-venice-edition:free</code> - Venice: Uncensored - OpenRouter</li>
                                <li><code>deepseek-ai/DeepSeek-V3</code> - DeepSeek V3 - DeepInfra</li>
                                <li><code>meta-llama/Llama-4-Scout-17B-16E-Instruct</code> - Llama 4 Scout 17B - DeepInfra</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <header>
                <h1><i class="fas fa-robot logo"></i> Adam's AI UI</h1>
                <div class="subtitle">Powered by OpenRouter API | v2.1</div>
                <div class="api-status">
                    <span class="status-dot" id="status-dot"></span>
                    <span id="status-text">Checking API</span>
                </div>
            </header>
            
            <div class="chat-container" id="chat-container">
                <div class="message ai-message">
                    <div class="message-content">
                        <i class="fas fa-robot"></i> Hello! I'm an AI assistant powered by OpenRouter. How can I help you today?
                    </div>
                    <span class="message-info">Model: <span id="current-model">deepseek/deepseek-chat-v3.1:free</span></span>
                </div>
            </div>
            
            <div class="typing-indicator" id="typing-indicator">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <span id="typing-model">AI is typing...</span>
            </div>
            
            <!-- Compact Document Upload Area -->
            <div class="document-upload">
                <div class="upload-header" id="upload-toggle">
                    <div class="upload-title">
                        <i class="fas fa-file-upload"></i>
                        <span>Attach Text Files</span>
                    </div>
                    <i class="fas fa-chevron-down" id="upload-chevron"></i>
                </div>
                
                <div class="upload-content" id="upload-content">
                    <div class="drop-area" id="drop-area">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <div class="drop-text">Drag & drop text files here or click to browse</div>
                        <div class="file-type-warning" id="file-type-warning">Only text-based files are supported (txt, json, yaml, xml, code files, etc.)</div>
                        <input type="file" id="file-input" class="file-input" multiple accept=".txt,.json,.yaml,.yml,.xml,.html,.css,.js,.py,.java,.cpp,.c,.cs,.php,.rb,.go,.rs,.ts,.md">
                        <button class="browse-btn" id="browse-btn">Browse Files</button>
                    </div>
                    
                    <div class="file-preview" id="file-preview">
                        <!-- Files will be previewed here -->
                    </div>
                </div>
                
                <div class="uploaded-files-indicator" id="uploaded-files-indicator" style="display: none;">
                    <i class="fas fa-paperclip"></i>
                    <span id="files-count">0</span> file(s) attached
                </div>
            </div>
            
            <div class="input-container">
                <input type="text" id="user-input" placeholder="Type your question about the uploaded files..." autocomplete="off" disabled>
                <button id="send-button" disabled>
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
            
            <div class="controls">
                <button id="clear-chat">
                    <i class="fas fa-trash"></i> Clear Chat
                </button>
                <button id="save-pdf">
                    <i class="fas fa-file-pdf"></i> Save as PDF
                </button>
                <button id="view-sessions">
                    <i class="fas fa-history"></i> Chat Sessions
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Sessions Panel -->
    <div class="chat-sessions-panel" id="chat-sessions-panel">
        <div class="sessions-header">
            <div class="sessions-title">Chat Sessions</div>
            <button class="close-sessions" id="close-sessions">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="sessions-content" id="sessions-content">
            <!-- Sessions will be loaded here -->
        </div>
        
        <div class="sessions-footer" style="padding: 15px;">
            <button class="new-session-btn" id="new-session-btn">
                <i class="fas fa-plus"></i> Start New Session
            </button>
        </div>
    </div>

    <div id="pdf-loading" class="pdf-loading">
        <div class="spinner"></div>
        <p>Generating PDF, please wait...</p>
    </div>

    <div class="version-info">v2.1 - Added file upload with text-only restriction, chat sessions, and file display in messages</div>

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        document.addEventListener('DOMContentLoaded', function() {
            const chatContainer = document.getElementById('chat-container');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const typingIndicator = document.getElementById('typing-indicator');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const configStatus = document.getElementById('config-status');
            const apiKeyInput = document.getElementById('api-key-input');
            const modelInput = document.getElementById('model-input');
            const endpointInput = document.getElementById('endpoint-input');
            const saveConfigButton = document.getElementById('save-config');
            const currentModelElement = document.getElementById('current-model');
            const typingModelElement = document.getElementById('typing-model');
            const cloudflareStatus = document.getElementById('cloudflare-status');
            const clearChatButton = document.getElementById('clear-chat');
            const savePdfButton = document.getElementById('save-pdf');
            const viewSessionsButton = document.getElementById('view-sessions');
            const pdfLoading = document.getElementById('pdf-loading');
            const sidebar = document.getElementById('sidebar');
            const toggleSidebarButton = document.getElementById('toggle-sidebar');
            const chatSessionsPanel = document.getElementById('chat-sessions-panel');
            const closeSessionsButton = document.getElementById('close-sessions');
            const sessionsContent = document.getElementById('sessions-content');
            const newSessionButton = document.getElementById('new-session-btn');
            
            // Document upload elements
            const uploadToggle = document.getElementById('upload-toggle');
            const uploadContent = document.getElementById('upload-content');
            const uploadChevron = document.getElementById('upload-chevron');
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            const browseBtn = document.getElementById('browse-btn');
            const filePreview = document.getElementById('file-preview');
            const fileTypeWarning = document.getElementById('file-type-warning');
            const uploadedFilesIndicator = document.getElementById('uploaded-files-indicator');
            const filesCount = document.getElementById('files-count');
            
            // API configuration
            let API_URL = 'https://openrouter.ai/api/v1/chat/completions';
            let API_KEY = '';
            let MODEL_NAME = 'deepseek/deepseek-chat-v3.1:free';
            
            // Track if Highlight.js is available
            let hljsAvailable = false;
            
            // Current session ID
            let currentSessionId = null;
            
            // Uploaded files
            let uploadedFiles = [];
            
            // Conversation history
            let conversationHistory = [
                {
                    role: 'system',
                    content: 'You are a helpful AI assistant. Format your responses using Markdown for better readability. Use code blocks for code snippets. When users upload files, help them analyze the content of those files.'
                }
            ];
            
            // Check if Highlight.js is loaded and available
            function checkHljsAvailability() {
                if (typeof hljs !== 'undefined' && hljs !== null) {
                    hljsAvailable = true;
                    console.log('Highlight.js is available');
                } else {
                    hljsAvailable = false;
                    console.warn('Highlight.js is not available, using fallback styling');
                }
            }
            
            // Configure marked to render code blocks with syntax highlighting
            marked.setOptions({
                highlight: function(code, lang) {
                    if (hljsAvailable && lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (e) {
                            console.error('Error highlighting code:', e);
                            return hljs.highlightAuto(code).value;
                        }
                    } else if (hljsAvailable) {
                        return hljs.highlightAuto(code).value;
                    } else {
                        return code;
                    }
                }
            });

            
            // Add copy buttons to code blocks
            function addCopyButtonsToCodeBlocks() {
                document.querySelectorAll('.message-content pre').forEach((preElement) => {
                    if (preElement.querySelector('.copy-button')) {
                        return;
                    }
                    
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-button';
                    copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
                    copyButton.title = 'Copy code to clipboard';
                    
                    copyButton.addEventListener('click', function() {
                        const codeElement = preElement.querySelector('code');
                        const codeToCopy = codeElement ? codeElement.textContent : preElement.textContent;
                        
                        navigator.clipboard.writeText(codeToCopy).then(() => {
                            copyButton.innerHTML = '<i class="fas fa-check"></i> Copied!';
                            copyButton.classList.add('copied');
                            
                            setTimeout(() => {
                                copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
                                copyButton.classList.remove('copied');
                            }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy code: ', err);
                            copyButton.innerHTML = '<i class="fas fa-times"></i> Failed';
                            
                            setTimeout(() => {
                                copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
                            }, 2000);
                        });
                    });
                    
                    preElement.appendChild(copyButton);
                });
            }
            
            // Save conversation as PDF
            async function saveAsPDF() {
                pdfLoading.style.display = 'flex';
                
                try {
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const margin = 20;
                    const contentWidth = pageWidth - (margin * 2);
                    let yPosition = margin;
                    
                    pdf.setFontSize(20);
                    pdf.setFont(undefined, 'bold');
                    pdf.setTextColor(99, 102, 241);
                    pdf.text('Adam\'s AI UI Conversation', pageWidth / 2, yPosition, { align: 'center' });
                    yPosition += 15;
                    
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'normal');
                    pdf.setTextColor(0, 0, 0);
                    const date = new Date().toLocaleString();
                    pdf.text(`Date: ${date}`, margin, yPosition);
                    yPosition += 8;
                    pdf.text(`Model: ${MODEL_NAME}`, margin, yPosition);
                    yPosition += 8;
                    pdf.text(`Total Messages: ${conversationHistory.length - 1}`, margin, yPosition);
                    yPosition += 15;
                    
                    pdf.setDrawColor(200, 200, 200);
                    pdf.line(margin, yPosition, pageWidth - margin, yPosition);
                    yPosition += 10;
                    
                    pdf.setFontSize(11);
                    
                    for (const message of conversationHistory) {
                        if (message.role === 'system') continue;
                        
                        if (yPosition > 250) {
                            pdf.addPage();
                            yPosition = margin;
                        }
                        
                        if (message.role === 'user') {
                            pdf.setFillColor(99, 102, 241);
                            pdf.setTextColor(255, 255, 255);
                        } else {
                            pdf.setFillColor(243, 244, 246);
                            pdf.setTextColor(0, 0, 0);
                        }
                        
                        const messageLines = pdf.splitTextToSize(message.content, contentWidth - 20);
                        const lineHeight = 7;
                        const messageHeight = messageLines.length * lineHeight + 10;
                        
                        pdf.roundedRect(margin, yPosition, contentWidth, messageHeight, 3, 3, 'F');
                        pdf.text(messageLines, margin + 10, yPosition + 10);
                        
                        pdf.setFont(undefined, 'bold');
                        if (message.role === 'user') {
                            pdf.text('User', margin + 10, yPosition + 5);
                        } else {
                            pdf.text('AI Assistant', margin + 10, yPosition + 5);
                        }
                        pdf.setFont(undefined, 'normal');
                        
                        yPosition += messageHeight + 10;
                    }
                    
                    const totalPages = pdf.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        pdf.setPage(i);
                        pdf.setFontSize(10);
                        pdf.setTextColor(100, 100, 100);
                        pdf.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pdf.internal.pageSize.getHeight() - 10, { align: 'right' });
                    }
                    
                    const dateStr = new Date().toISOString().slice(0, 10);
                    pdf.save(`Adams-AI-UI-${dateStr}.pdf`);
                    
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                } finally {
                    pdfLoading.style.display = 'none';
                }
            }
            
            // Toggle sidebar visibility
            function toggleSidebar() {
                sidebar.classList.toggle('collapsed');
                
                const icon = toggleSidebarButton.querySelector('i');
                if (sidebar.classList.contains('collapsed')) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-chevron-right');
                } else {
                    icon.classList.remove('fa-chevron-right');
                    icon.classList.add('fa-bars');
                }
                
                localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
            }
            
            // Toggle upload area visibility
            function toggleUploadArea() {
                uploadContent.classList.toggle('expanded');
                
                if (uploadContent.classList.contains('expanded')) {
                    uploadChevron.classList.remove('fa-chevron-down');
                    uploadChevron.classList.add('fa-chevron-up');
                } else {
                    uploadChevron.classList.remove('fa-chevron-up');
                    uploadChevron.classList.add('fa-chevron-down');
                }
            }
            
            // Open the sessions panel
            function openSessionsPanel() {
                chatSessionsPanel.classList.add('open');
                renderSessions();
            }
            
            // Close the sessions panel
            function closeSessionsPanel() {
                chatSessionsPanel.classList.remove('open');
            }
            
            // Check for Cloudflare Pages environment variable
            function checkCloudflareEnv() {
                const cfApiKey = '{{API_KEY}}';
                
                if (cfApiKey && cfApiKey !== '{{API_KEY}}' && cfApiKey.length > 10) {
                    API_KEY = cfApiKey;
                    cloudflareStatus.innerHTML = `<i class="fas fa-check-circle"></i> <span>Using API key from Cloudflare environment variable: <code>${cfApiKey.substring(0, 10)}...</code></span>`;
                    cloudflareStatus.classList.add('success');
                    return true;
                } else {
                    cloudflareStatus.style.display = 'none';
                    return false;
                }
            }
            
            // Initialize the app
            function initializeConfig() {
                const sidebarCollapsed = localStorage.getItem('sidebarCollapsed');
                if (sidebarCollapsed === 'true') {
                    sidebar.classList.add('collapsed');
                    const icon = toggleSidebarButton.querySelector('i');
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-chevron-right');
                }
                
                const cloudflareResult = checkCloudflareEnv();
                
                const savedModel = localStorage.getItem('openrouter_model');
                const savedEndpoint = localStorage.getItem('api_endpoint');
                if (savedEndpoint) {
                    API_URL = savedEndpoint;
                    endpointInput.value = savedEndpoint;
                }
                if (savedModel) {
                    MODEL_NAME = savedModel;
                    modelInput.value = savedModel;
                    currentModelElement.textContent = savedModel;
                    typingModelElement.textContent = `${savedModel.split('/').pop()} is typing...`;
                }
                
                const savedApiKey = localStorage.getItem('openrouter_api_key');
                if (savedApiKey) {
                    API_KEY = savedApiKey;
                    apiKeyInput.value = savedApiKey;
                    configStatus.innerHTML = `Configuration loaded from browser storage. Using model: <code>${MODEL_NAME}</code>` + 
                                            (API_KEY ? '' : '<br><span style="color: var(--warning);">Warning: No API key configured</span>');
                    updateStatus('API key loaded', true);
                    
                    // Load the most recent session or create a new one
                    loadSessions();
                    
                    return true;
                }
                
                if (cloudflareResult) {
                    configStatus.innerHTML = `Configuration loaded from Cloudflare. Using model: <code>${MODEL_NAME}</code>` + 
                                            (API_KEY ? '' : '<br><span style="color: var(--warning);">Warning: No API key configured</span>');
                    updateStatus('API key loaded', true);
                    
                    // Load the most recent session or create a new one
                    loadSessions();
                    
                    return true;
                }
                
                configStatus.innerHTML = 'Please configure your API settings above';
                updateStatus('API key required', false);
                
                // Create a new session if no API key is configured
                currentSessionId = 'session_' + Date.now();
                
                setTimeout(() => {
                    addCopyButtonsToCodeBlocks();
                }, 100);
                
                return false;
            }
            
            // Save the current session to localStorage
            function saveSession() {
                if (!currentSessionId) return;
                
                const sessionData = {
                    id: currentSessionId,
                    title: getSessionTitle(),
                    preview: getSessionPreview(),
                    history: conversationHistory,
                    timestamp: new Date().toISOString(),
                    model: MODEL_NAME
                };
                
                // Get existing sessions
                const sessions = getSessions();
                
                // Update or add the current session
                const existingIndex = sessions.findIndex(s => s.id === currentSessionId);
                if (existingIndex !== -1) {
                    sessions[existingIndex] = sessionData;
                } else {
                    sessions.push(sessionData);
                }
                
                // Save to localStorage
                localStorage.setItem('chat_sessions', JSON.stringify(sessions));
                
                // Update the sessions panel
                renderSessions();
            }
            
            // Get all sessions from localStorage
            function getSessions() {
                const sessionsJson = localStorage.getItem('chat_sessions');
                return sessionsJson ? JSON.parse(sessionsJson) : [];
            }
            
            // Generate a session title based on the first user message
            function getSessionTitle() {
                const firstUserMessage = conversationHistory.find(msg => msg.role === 'user');
                if (firstUserMessage) {
                    // Truncate if too long
                    return firstUserMessage.content.length > 30 
                        ? firstUserMessage.content.substring(0, 30) + '...' 
                        : firstUserMessage.content;
                }
                return 'New Chat';
            }
            
            // Generate a session preview based on the last message
            function getSessionPreview() {
                const lastMessage = [...conversationHistory].reverse().find(msg => 
                    msg.role === 'user' || msg.role === 'assistant'
                );
                
                if (lastMessage) {
                    // Remove markdown and truncate
                    const plainText = lastMessage.content.replace(/[#*_`~]/g, '');
                    return plainText.length > 50 
                        ? plainText.substring(0, 50) + '...' 
                        : plainText;
                }
                return 'No messages yet';
            }
            
            // Load a specific session
            function loadSession(sessionId) {
                const sessions = getSessions();
                const session = sessions.find(s => s.id === sessionId);
                
                if (session) {
                    conversationHistory = session.history;
                    currentSessionId = sessionId;
                    
                    // Re-render the conversation
                    renderConversationHistory();
                    
                    // Update the sessions panel
                    renderSessions();
                    
                    // Add a message indicating the session was loaded
                    addMessage(`Session "${session.title}" loaded.`, 'ai');
                }
            }
            
            // Create a new session
            function createNewSession() {
                // Save the current session first
                if (currentSessionId && conversationHistory.length > 1) {
                    saveSession();
                }
                
                // Generate a new session ID
                currentSessionId = 'session_' + Date.now();
                
                // Reset conversation history
                conversationHistory = [
                    {
                        role: 'system',
                        content: 'You are a helpful AI assistant. Format your responses using Markdown for better readability. Use code blocks for code snippets. When users upload files, help them analyze the content of those files.'
                    }
                ];
                
                // Clear the chat container except for the first message
                while (chatContainer.children.length > 1) {
                    chatContainer.removeChild(chatContainer.lastChild);
                }
                
                // Clear uploaded files
                uploadedFiles = [];
                renderFilePreviews();
                
                // Add a welcome message
                addMessage('Started a new chat session. How can I help you?', 'ai');
                
                // Update the sessions panel
                renderSessions();
            }
            
            // Delete a session
            function deleteSession(sessionId) {
                if (!confirm('Are you sure you want to delete this chat session?')) {
                    return;
                }
                
                const sessions = getSessions();
                const updatedSessions = sessions.filter(s => s.id !== sessionId);
                
                // If we're deleting the current session, create a new one
                if (sessionId === currentSessionId) {
                    createNewSession();
                }
                
                // Save to localStorage
                localStorage.setItem('chat_sessions', JSON.stringify(updatedSessions));
                
                // Update the sessions panel
                renderSessions();
            }
            
            // Render the sessions panel
            function renderSessions() {
                const sessions = getSessions();
                
                // Sort sessions by timestamp (newest first)
                sessions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Clear the sessions panel
                sessionsContent.innerHTML = '';
                
                if (sessions.length === 0) {
                    sessionsContent.innerHTML = '<div class="no-sessions">No chat sessions yet</div>';
                    return;
                }
                
                // Add each session to the panel
                sessions.forEach(session => {
                    const sessionElement = document.createElement('div');
                    sessionElement.className = 'session-item';
                    if (session.id === currentSessionId) {
                        sessionElement.classList.add('active');
                    }
                    
                    sessionElement.innerHTML = `
                        <div class="session-title">
                            <span>${session.title}</span>
                            <div class="session-actions">
                                <button class="session-action delete-session" data-id="${session.id}" title="Delete session">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="session-preview">${session.preview}</div>
                        <div class="session-date">${new Date(session.timestamp).toLocaleString()}</div>
                    `;
                    
                    // Add click event to load the session
                    sessionElement.addEventListener('click', (e) => {
                        if (!e.target.closest('.session-actions')) {
                            loadSession(session.id);
                            closeSessionsPanel();
                        }
                    });
                    
                    sessionsContent.appendChild(sessionElement);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-session').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteSession(button.dataset.id);
                    });
                });
            }
            
            // Load all sessions (for the sessions panel)
            function loadSessions() {
                const sessions = getSessions();
                
                if (sessions.length > 0) {
                    // Load the most recent session
                    const mostRecent = sessions.sort((a, b) => 
                        new Date(b.timestamp) - new Date(a.timestamp)
                    )[0];
                    
                    loadSession(mostRecent.id);
                } else {
                    // Create a new session
                    currentSessionId = 'session_' + Date.now();
                }
                
                // Render the sessions panel
                renderSessions();
            }
            
            // Render conversation history
            function renderConversationHistory() {
                // Clear the chat container except for the first message
                while (chatContainer.children.length > 1) {
                    chatContainer.removeChild(chatContainer.lastChild);
                }
                
                // Add messages from history (skip system message)
                for (const message of conversationHistory) {
                    if (message.role === 'user') {
                        addMessage(message.content, 'user', false);
                    } else if (message.role === 'assistant') {
                        addMessage(message.content, 'ai', false);
                    }
                }                
                
                // Add copy buttons to code blocks in history
                setTimeout(() => {
                    addCopyButtonsToCodeBlocks();
                }, 100);                
            }
            
            // Update connection status UI
            function updateStatus(text, connected) {
                statusText.textContent = text;
                if (connected) {
                    statusDot.classList.add('connected');
                    statusDot.classList.remove('error');
                } else {
                    statusDot.classList.add('error');
                    statusDot.classList.remove('connected');
                }
            }
            
            // Add message to chat with markdown support
            function addMessage(text, sender, addToHistory = true, files = []) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                messageElement.classList.add(sender + '-message');
                
                const messageContent = document.createElement('div');
                messageContent.classList.add('message-content');
                
                const icon = document.createElement('i');
                icon.className = sender === 'ai' ? 'fas fa-robot' : 'fas fa-user';
                
                if (sender === 'ai') {
                    messageContent.innerHTML = marked.parse(text);
                } else {
                    messageContent.textContent = text;
                    
                    // Add file attachments if any
                    if (files.length > 0) {
                        const attachmentContainer = document.createElement('div');
                        attachmentContainer.style.marginTop = '10px';
                        
                        files.forEach(file => {
                            const attachment = document.createElement('div');
                            attachment.className = 'file-attachment';
                            
                            let fileIcon = 'file-alt';
                            if (file.name.endsWith('.json')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.yaml') || file.name.endsWith('.yml')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.xml')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.html')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.css')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.js')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.py')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.java')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.cpp') || file.name.endsWith('.c')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.cs')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.php')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.rb')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.go')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.rs')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.ts')) fileIcon = 'file-code';
                            else if (file.name.endsWith('.md')) fileIcon = 'file-alt';
                            
                            attachment.innerHTML = `
                                <div class="file-attachment-icon">
                                    <i class="fas fa-${fileIcon}"></i>
                                </div>
                                <div class="file-attachment-name">${file.name}</div>
                            `;
                            
                            attachmentContainer.appendChild(attachment);
                        });
                        
                        messageContent.appendChild(attachmentContainer);
                    }
                }
                
                messageElement.appendChild(icon);
                messageElement.appendChild(messageContent);
                
                chatContainer.appendChild(messageElement);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                if (!hljsAvailable) {
                    messageContent.querySelectorAll('pre code').forEach((block) => {
                        block.classList.add('hljs-fallback');
                    });
                } else {
                    messageContent.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }
                
                setTimeout(() => {
                    addCopyButtonsToCodeBlocks();
                }, 100);
                
                // Add to conversation history
                if (addToHistory) {
                    if (sender === 'user') {
                        conversationHistory.push({ role: 'user', content: text });
                    } else if (sender === 'ai') {
                        conversationHistory.push({ role: 'assistant', content: text });
                    }
                    
                    // Save the session
                    saveSession();
                }
            }
            
            // Show/hide typing indicator
            function setTyping(visible) {
                typingIndicator.classList.toggle('active', visible);
                if (visible) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
            
            // Read file content
            function readFileContent(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        resolve({
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            content: event.target.result
                        });
                    };
                    
                    reader.onerror = (error) => {
                        reject(error);
                    };
                    
                    reader.readAsText(file);
                });
            }
            
            // Process uploaded files and add to conversation
            async function processUploadedFiles() {
                if (uploadedFiles.length === 0) return '';
                
                let fileContents = 'I have uploaded the following text files. Please analyze their content:\n';
                
                for (const file of uploadedFiles) {
                    try {
                        const fileData = await readFileContent(file);
                        fileContents += `\n--- ${fileData.name} ---\n${fileData.content}\n`;
                    } catch (error) {
                        console.error('Error reading file:', error);
                        fileContents += `\n--- ${file.name} ---\n(Error reading file)\n`;
                    }
                }
                
                return fileContents;
            }
            
            // Format file size
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Send message to API
            async function sendMessage() {
                const message = userInput.value.trim();
                if (!message && uploadedFiles.length === 0) return;
                
                const fileContents = await processUploadedFiles();
                const fullMessage = message + (fileContents ? `\n\n${fileContents}` : '');
                
                // Add user message to chat with file attachments
                addMessage(message, 'user', true, uploadedFiles);
                userInput.value = '';
                sendButton.disabled = true;
                setTyping(true);
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_KEY}`,
                            'HTTP-Referer': window.location.href,
                            'X-Title': 'Adam\'s AI UI'
                        },
                        body: JSON.stringify({
                            model: MODEL_NAME,
                            messages: [
                                {
                                    role: 'system',
                                    content: 'You are a helpful AI assistant. Analyze the content of any uploaded text files and provide helpful responses based on the file content. Format your responses using Markdown for better readability. Use code blocks for code snippets.'
                                },
                                ...conversationHistory.filter(msg => msg.role !== 'system'),
                                { role: 'user', content: fullMessage }
                            ]
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content;

                    setTyping(false);
                    addMessage(aiResponse, 'ai');
                    updateStatus('Response received', true);
                    
                    uploadedFiles = [];
                    renderFilePreviews();
                } catch (error) {
                    setTyping(false);
                    addMessage(`Error: ${error.message}. Please check your API key and try again.`, 'ai');
                    updateStatus('API error', false);
                    console.error('Error:', error);
                }
                
                sendButton.disabled = false;
                userInput.focus();
            }
            
            // Save configuration
            function saveConfig() {
                const key = apiKeyInput.value.trim();
                const endpoint = endpointInput.value.trim();
                const model = modelInput.value.trim();
                          
                if (!endpoint) {
                    alert('Please enter an API endpoint');
                    return;
                }
                
                if (!key) {
                    if (!confirm('Warning: No API key provided. Some endpoints may not work without authentication. Continue anyway?')) {
                        return;
                    }
                }
                
                API_KEY = key;
                API_URL = endpoint;
                MODEL_NAME = model;
                
                localStorage.setItem('openrouter_api_key', key);
                localStorage.setItem('api_endpoint', endpoint);
                localStorage.setItem('openrouter_model', model);
                
                currentModelElement.textContent = model;
                typingModelElement.textContent = `${model.split('/').pop()} is typing...`;
                configStatus.innerHTML = `Configuration saved. Using model: <code>${model}</code>` + 
                                        (key ? '' : '<br><span style="color: var(--warning);">Warning: No API key configured</span>');
                
                updateStatus('API key loaded', true);
                
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
                
                addMessage('Configuration saved successfully. You can now start chatting!', 'ai');
            }
            
            // Clear chat history
            function clearChat() {
                if (confirm('Are you sure you want to clear the conversation history?')) {
                    conversationHistory = [
                        {
                            role: 'system',
                            content: 'You are a helpful AI assistant. Format your responses using Markdown for better readability. Use code blocks for code snippets. When users upload files, help them analyze the content of those files.'
                        }
                    ];
                    
                    uploadedFiles = [];
                    renderFilePreviews();
                    
                    // Save the cleared session
                    saveSession();
                    
                    // Clear the chat container except for the first message
                    while (chatContainer.children.length > 1) {
                        chatContainer.removeChild(chatContainer.lastChild);
                    }
                    
                    addMessage('Conversation history has been cleared.', 'ai');
                }
            }
            
            // Handle file uploads
            function handleFiles(files) {
                let hasInvalidFile = false;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // Check if file is a text file
                    const isTextFile = file.type.startsWith('text/') || 
                                      file.name.endsWith('.txt') || 
                                      file.name.endsWith('.json') || 
                                      file.name.endsWith('.yaml') || 
                                      file.name.endsWith('.yml') || 
                                      file.name.endsWith('.xml') || 
                                      file.name.endsWith('.html') || 
                                      file.name.endsWith('.css') || 
                                      file.name.endsWith('.js') || 
                                      file.name.endsWith('.py') || 
                                      file.name.endsWith('.java') || 
                                      file.name.endsWith('.cpp') || 
                                      file.name.endsWith('.c') || 
                                      file.name.endsWith('.cs') || 
                                      file.name.endsWith('.php') || 
                                      file.name.endsWith('.rb') || 
                                      file.name.endsWith('.go') || 
                                      file.name.endsWith('.rs') || 
                                      file.name.endsWith('.ts') || 
                                      file.name.endsWith('.md');
                    
                    if (!isTextFile) {
                        hasInvalidFile = true;
                        continue;
                    }
                    
                    if (!uploadedFiles.some(f => f.name === file.name && f.size === file.size && f.type === file.type)) {
                        uploadedFiles.push(file);
                    }
                }
                
                if (hasInvalidFile) {
                    fileTypeWarning.style.display = 'block';
                    setTimeout(() => {
                        fileTypeWarning.style.display = 'none';
                    }, 5000);
                }
                
                renderFilePreviews();
            }
            
            // Render file previews
            function renderFilePreviews() {
                filePreview.innerHTML = '';
                
                if (uploadedFiles.length === 0) {
                    uploadedFilesIndicator.style.display = 'none';
                    userInput.placeholder = "Type your message here...";
                    return;
                }
                
                uploadedFilesIndicator.style.display = 'flex';
                filesCount.textContent = uploadedFiles.length;
                
                if (uploadedFiles.length > 0) {
                    userInput.placeholder = "Type your question about the uploaded files...";
                }
                
                uploadedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    let fileIcon = 'file-alt';
                    if (file.name.endsWith('.json')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.yaml') || file.name.endsWith('.yml')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.xml')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.html')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.css')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.js')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.py')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.java')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.cpp') || file.name.endsWith('.c')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.cs')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.php')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.rb')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.go')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.rs')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.ts')) fileIcon = 'file-code';
                    else if (file.name.endsWith('.md')) fileIcon = 'file-alt';
                    
                    const fileSize = formatFileSize(file.size);
                    
                    fileItem.innerHTML = `
                        <div class="file-info">
                            <div class="file-icon">
                                <i class="fas fa-${fileIcon}"></i>
                            </div>
                            <div class="file-details">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${fileSize}</div>
                            </div>
                        </div>
                        <button class="file-remove" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    filePreview.appendChild(fileItem);
                });
                
                document.querySelectorAll('.file-remove').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = parseInt(button.dataset.index);
                        uploadedFiles.splice(index, 1);
                        renderFilePreviews();
                    });
                });
            }
            
            // Event listeners
            sendButton.addEventListener('click', sendMessage);
            saveConfigButton.addEventListener('click', saveConfig);
            clearChatButton.addEventListener('click', clearChat);
            toggleSidebarButton.addEventListener('click', toggleSidebar);
            savePdfButton.addEventListener('click', saveAsPDF);
            viewSessionsButton.addEventListener('click', openSessionsPanel);
            closeSessionsButton.addEventListener('click', closeSessionsPanel);
            newSessionButton.addEventListener('click', createNewSession);
            uploadToggle.addEventListener('click', toggleUploadArea);
            browseBtn.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
                fileInput.value = '';
            });
            
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('active');
            });
            
            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('active');
            });
            
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('active');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files);
                }
            });
            
            dropArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            apiKeyInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveConfig();
                }
            });
            
            modelInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveConfig();
                }
            });

            endpointInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveConfig();
                }
            });
            
            // Initialize the app
            initializeConfig();
            checkApiKey();
            checkHljsAvailability();
        });
    </script>
</body>
</html>
